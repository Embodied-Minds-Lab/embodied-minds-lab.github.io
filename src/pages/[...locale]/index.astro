---
import { i18n } from "astro:config/client";
import { render, getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import { Icon } from "astro-icon/components";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import config from "$config";
import i18nit from "$i18n";
import { people } from "$data/people";

export async function getStaticPaths() {
	// Create path for each locale, omitting default locale from URL
	return i18n!.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}

const { locale = i18n!.defaultLocale } = Astro.params;

const t = i18nit(locale);
const baseUrl = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

// Get preface content, sorted by timestamp (newest first)
const prefaces = (
	await getCollection("preface", preface => {
		const [, id] = preface.id.split("/");
		preface.id = id;
		return true;
	})
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);

// Filter people with images for the grid
const peopleWithImages = people.filter(person => person.image);
---

<Base title={t("navigation.home")} {locale}>
	<main class="flex flex-col gap-5 sm:gap-10 flex-grow">
		<header class="flex items-center justify-center grow-0.6">
			<div class="people-grid-home">
				{peopleWithImages.map((person) => (
					<a href={getRelativeLocaleUrl(locale, "/people")} class="person-square" title={person.name}>
						<img src={`${baseUrl}${person.image.replace(/^\//, '')}`} alt={person.name} loading="lazy" />
					</a>
				))}
			</div>
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href={getRelativeLocaleUrl(locale, "/preface")} class="self-end my-2 text-size-sm c-secondary">
						—— {Time.date.locale(preface.data.timestamp, locale)}
					</a>
				</section>
			)
		}

	</main>
</Base>

<style>
	.people-grid-home {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		justify-content: center;
		max-width: 800px;
	}

	.person-square {
		width: 70px;
		height: 70px;
		border-radius: 4px;
		overflow: hidden;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
	}

	.person-square:hover {
		transform: scale(1.1);
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
		z-index: 10;
	}

	.person-square img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	@media (max-width: 768px) {
		.person-square {
			width: 60px;
			height: 60px;
		}
		
		.people-grid-home {
			gap: 0.4rem;
		}
	}
</style>
