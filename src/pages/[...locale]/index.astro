---
import { i18n } from "astro:config/client";
import { render, getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import { Icon } from "astro-icon/components";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import config from "$config";
import i18nit from "$i18n";

export async function getStaticPaths() {
	// Create path for each locale, omitting default locale from URL
	return i18n!.locales.map(locale => ({ params: { locale: locale == i18n?.defaultLocale ? undefined : (locale as string) } }));
}

const { locale = i18n!.defaultLocale } = Astro.params;

const t = i18nit(locale);
const baseUrl = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

// Get preface content, sorted by timestamp (newest first)
const prefaces = (
	await getCollection("preface", preface => {
		const [, id] = preface.id.split("/");
		preface.id = id;
		return true;
	})
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);
---

<Base title={t("navigation.home")} {locale}>
	<main class="flex flex-col gap-5 sm:gap-10 flex-grow">
		<header class="flex items-center justify-center grow-0.6">
			<img src={`${baseUrl}lab-photo.png`} alt="Lab Photo" class="max-w-full h-auto" style="max-width: 500px; width: 100%;" />
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href={getRelativeLocaleUrl(locale, "/preface")} class="self-end my-2 text-size-sm c-secondary">
						—— {Time.date.locale(preface.data.timestamp, locale)}
					</a>
				</section>
			)
		}

	</main>
</Base>
