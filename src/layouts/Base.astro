---
import { i18n } from "astro:config/client";
import { getRelativeLocaleUrl } from "astro:i18n";
import { Icon } from "astro-icon/components";
import config from "$config";
import App from "$layouts/App.astro";
import Navigator from "$layouts/header/Navigator.svelte";
import Footer from "$layouts/Footer.astro";
import Tip from "$components/Tip.svelte";
import "$styles/global.less";
import "$styles/markdown.less";
import "medium-zoom/dist/style.css";

let route = Astro.url.pathname;

const { locale = i18n?.defaultLocale, title: subtitle, description = config.description, article } = Astro.props;
const title = config.title;
const baseUrl = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
---

<script>
	import zoom from "medium-zoom/dist/pure";

	window.zoom = () => zoom(".markdown img", { background: "#00000044" });
	window.zoom();

	document.addEventListener("astro:page-load", () => {
		window.zoom();
	});
</script>

<script>
	// Global initialization function for page-specific features
	function initPageFeatures() {
		console.log('initPageFeatures called');
		
		// Initialize publication filters if on publications page
		const yearFilters = document.querySelectorAll('.year-filter');
		const venueFilters = document.querySelectorAll('.venue-filter');
		const publicationCards = document.querySelectorAll('.publication-card');
		
		if (publicationCards.length > 0) {
			console.log('Initializing publications filters:', yearFilters.length, 'year filters,', venueFilters.length, 'venue filters,', publicationCards.length, 'cards');
			
			function filterPublications() {
				const selectedYears = Array.from(yearFilters)
					.filter((f: HTMLInputElement) => f.checked)
					.map((f: HTMLInputElement) => parseInt(f.dataset.value || '0'));
				
				const selectedVenues = Array.from(venueFilters)
					.filter((f: HTMLInputElement) => f.checked)
					.map((f: HTMLInputElement) => f.dataset.value || '');

				console.log('Filtering with years:', selectedYears, 'venues:', selectedVenues);

				publicationCards.forEach((card: Element) => {
					const year = parseInt((card as HTMLElement).dataset.year || '0');
					const venue = (card as HTMLElement).dataset.venue || '';
					let show = true;

					if (selectedYears.length > 0) {
						show = selectedYears.includes(year);
					}

					if (show && selectedVenues.length > 0) {
						show = selectedVenues.includes(venue);
					}

					(card as HTMLElement).style.display = show ? '' : 'none';
				});
			}

			yearFilters.forEach((checkbox) => {
				checkbox.addEventListener('change', filterPublications);
			});
			venueFilters.forEach((checkbox) => {
				checkbox.addEventListener('change', filterPublications);
			});
			
			console.log('Publications filter listeners attached');
		}
		
		// Initialize show more buttons if on people page
		const bioContainers = document.querySelectorAll('.person-bio-container');
		
		if (bioContainers.length > 0) {
			console.log('Initializing people page show more buttons:', bioContainers.length, 'containers');
			
			bioContainers.forEach((container: Element) => {
				const bio = container.querySelector('.person-bio');
				const btn = container.querySelector('.show-more-btn');
				
				(container as Element).classList.remove('has-overflow');
				
				if (bio && bio.scrollHeight > bio.clientHeight) {
					(container as Element).classList.add('has-overflow');
					
					if (btn) {
						const newBtn = btn.cloneNode(true) as HTMLElement;
						btn.parentNode?.replaceChild(newBtn, btn);
						
						newBtn.addEventListener('click', function() {
							const isExpanded = bio.classList.contains('expanded');
							bio.classList.toggle('expanded');
							newBtn.textContent = isExpanded ? 'Show more' : 'Show less';
						});
					}
				}
			});
			
			console.log('People page show more buttons initialized');
		}
	}

	// Run on initial page load
	if (document.readyState === 'complete') {
		initPageFeatures();
	} else {
		document.addEventListener('DOMContentLoaded', initPageFeatures);
	}

	// Re-run after Swup page transitions
	if (window.swup) {
		window.swup.hooks.on('page:view', () => {
			console.log('Swup page:view event - reinitializing features');
			// Use requestAnimationFrame to ensure DOM is updated
			requestAnimationFrame(initPageFeatures);
		});
	} else {
		document.addEventListener('swup:enable', () => {
			console.log('Swup enabled - registering page:view hook');
			window.swup?.hooks.on('page:view', () => {
				console.log('Swup page:view event - reinitializing features');
				requestAnimationFrame(initPageFeatures);
			});
		});
	}
</script>

<App {title} {subtitle} {description} {article} author={typeof config.author == "string" ? config.author : config.author.name}>
	<Tip client:load>
		<Icon name="lucide:info" slot="information" is:inline />
		<Icon name="lucide:circle-check" slot="success" is:inline />
		<Icon name="lucide:circle-question-mark" slot="question" is:inline />
		<Icon name="lucide:circle-alert" slot="warning" is:inline />
		<Icon name="lucide:circle-x" slot="error" is:inline />
		<Icon name="lucide:x" slot="x" is:inline />
	</Tip>
	<div class="flex flex-col mx-a px-3 w-[min(100%,1000px)]">
		<div id="body" class="flex flex-col min-h-screen">
			<header class="sticky top-0 flex items-center justify-between pt-3 pb-1 mb-4 bg-background z-2 sm:(static pb-12)">
				<a href={getRelativeLocaleUrl(locale)} class="text-size-xl sm:text-size-3xl font-bold">
					<img src={`${baseUrl}logo.svg`} alt={title} class="h-8 sm:h-10" />
				</a>

				<Navigator {locale} {route} {baseUrl} client:load>
					<Icon name="lucide:tent" slot="home" is:inline />
					<Icon name="lucide:list" slot="note" />
					<Icon name="lucide:at-sign" slot="about" />
					<Icon name="lucide:feather" slot="jotting" />
					<Icon name="lucide:user-round" slot="people" />
					<Icon name="lucide:sun" slot="sun" />
					<Icon name="lucide:moon" slot="moon" />
					<Icon name="lucide:align-justify" slot="bars" />
					<Icon name="lucide:x" slot="close" is:inline />
				</Navigator>
			</header>

			<slot />
		</div>

		<Footer {locale} author={config.author} copyright={config.copyright} />
	</div>
</App>
